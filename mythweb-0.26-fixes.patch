 classes/Video.php                    | 14 ++++----
 modules/stream/stream_raw.pl         |  4 +++
 modules/tv/classes/Schedule.php      | 41 +++++++++++++++++++++
 modules/tv/detail.php                | 37 ++-----------------
 modules/tv/schedules_custom.php      | 39 ++------------------
 modules/tv/schedules_manual.php      | 35 ++----------------
 modules/tv/tmpl/default/detail.php   |  2 +-
 modules/tv/tmpl/default/recorded.php |  2 +-
 modules/tv/tmpl/lite/detail.php      |  2 +-
 modules/video/handler.php            | 26 +++++++++-----
 modules/video/stream.php             | 69 ++++++++++++++++++++++++++++++++++++
 modules/video/tmpl/default/video.php |  2 +-
 mythweb.php                          |  2 +-
 13 files changed, 152 insertions(+), 123 deletions(-)

diff --git a/classes/Video.php b/classes/Video.php
index 7995aa4..5c6f7e4 100644
--- a/classes/Video.php
+++ b/classes/Video.php
@@ -90,12 +90,14 @@ class Video {
         $this->childid = $video['childid'];
     // Figure out the URL
         $this->url = '#';
-        if (file_exists('data/video/'))
-            $this->url = implode('/', array_map('rawurlencode',
-                                             array_map('utf8tolocal',
-                                             explode('/',
-                                             'data/video/' . preg_replace('#^'.$mythvideo_dir.'/?#', '', $this->filename)
-                                       ))));
+    //// all junk, replacing
+//        if (file_exists('data/video/'))
+//            $this->url = implode('/', array_map('rawurlencode',
+//                                             array_map('utf8tolocal',
+//                                             explode('/',
+//                                             'data/video/' . preg_replace('#^'.$mythvideo_dir.'/?#', '', $this->filename)
+//                                       ))));
+        $this->url = 'video/stream?Id=' . $this->intid;
         $genre = $db->query('SELECT idgenre
                                FROM videometadatagenre
                               WHERE idvideo = ?',
diff --git a/modules/stream/stream_raw.pl b/modules/stream/stream_raw.pl
index 31f6854..6981bca 100755
--- a/modules/stream/stream_raw.pl
+++ b/modules/stream/stream_raw.pl
@@ -30,6 +30,10 @@
         $type   = 'video/nuppelvideo';
         $suffix = '.nuv';
     }
+    elsif ($basename =~ /\.mkv$/) {
+        $type   = 'video/x-matroska';
+        $suffix = '.mkv';
+    }
     else {
         print header(),
               "Unknown video type requested:  $basename\n";
diff --git a/modules/tv/classes/Schedule.php b/modules/tv/classes/Schedule.php
index 3d9400f..0ad566d 100644
--- a/modules/tv/classes/Schedule.php
+++ b/modules/tv/classes/Schedule.php
@@ -240,6 +240,47 @@ class Schedule extends MythBase {
     }
 
 /**
+ * Alternative constructor for returning recording templates
+ **/
+    static function recording_template($name) {
+        global $db;
+        $sched = new Schedule(NULL);
+        $data = $db->query_assoc('
+            SELECT *
+            FROM   record
+            WHERE  type = ?
+            AND    title = ?',
+            rectype_template,
+            $name.' (Template)'
+        );
+
+        $template_params = array(
+            'recpriority', 'prefinput', 'startoffset', 'endoffset',
+            'dupmethod', 'dupin', 'filter', 'inactive',
+            'profile', 'recgroup', 'storagegroup', 'playgroup', 'autoexpire',
+            'maxepisodes', 'maxnewest',
+            'autocommflag', 'autotranscode', 'transcoder',
+            'autouserjob1', 'autouserjob2', 'autouserjob3', 'autouserjob4',
+            'autometadata');
+        foreach ($template_params as $param)
+            if (isset($data[$param]))
+                $sched->$param = $data[$param];
+
+        return $sched;
+    }
+
+/**
+ * Merge values from another schedule
+ **/
+    public function merge($prog) {
+        foreach (get_object_vars($prog) as $name => $value) {
+            if ($value && !$this->$name) {
+                $this->$name = $value;
+            }
+        }
+    }
+
+/**
  * Save this schedule
 /**/
     public function save($new_type) {
diff --git a/modules/tv/detail.php b/modules/tv/detail.php
index 27637c2..48bdb53 100644
--- a/modules/tv/detail.php
+++ b/modules/tv/detail.php
@@ -269,42 +269,9 @@
     // Redirect back to the page again, but without the query string, so reloads are cleaner
         redirect_browser(root_url.'tv/detail/'.$program->chanid.'/'.$program->starttime);
     }
-// Load default settings for recpriority, autoexpire etc
     else {
-    // auto-metadata-lookup
-        if (!isset($schedule->autometadata))
-            $schedule->autometadata = setting('AutoMetadataLookup');
-    // auto-commercial-flag
-        if (!isset($schedule->autocommflag))
-            $schedule->autocommflag = setting('AutoCommercialFlag');
-    // auto-user-jobs
-        if (!isset($schedule->autouserjob1))
-            $schedule->autouserjob1 = setting('AutoRunUserJob1');
-        if (!isset($schedule->autouserjob2))
-            $schedule->autouserjob2 = setting('AutoRunUserJob2');
-        if (!isset($schedule->autouserjob3))
-            $schedule->autouserjob3 = setting('AutoRunUserJob3');
-        if (!isset($schedule->autouserjob4))
-            $schedule->autouserjob4 = setting('AutoRunUserJob4');
-    // auto-transcode
-        if (!isset($schedule->autotranscode))
-            $schedule->autotranscode = setting('AutoTranscode');
-    // transcoder
-        if (!isset($schedule->transcoder))
-            $schedule->transcoder = setting('DefaultTranscoder');
-    // recpriority
-        if (!isset($schedule->recpriority)) {
-            $schedule->recpriority = $db->query_col('SELECT recpriority from channel where chanid=?',
-                                                    $program->chanid);
-        }
-    // autoexpire
-        if (!isset($schedule->autoexpire))
-            $schedule->autoexpire = setting('AutoExpireDefault');
-    // start early / end late
-        if (!isset($schedule->startoffset))
-            $schedule->startoffset = setting('DefaultStartOffset');
-        if (!isset($schedule->endoffset))
-            $schedule->endoffset = setting('DefaultEndOffset');
+    // Load default values from Default recording rule template
+        $schedule->merge(Schedule::recording_template('Default'));
     }
 
 // Load the channel
diff --git a/modules/tv/schedules_custom.php b/modules/tv/schedules_custom.php
index 623db4b..035c46b 100644
--- a/modules/tv/schedules_custom.php
+++ b/modules/tv/schedules_custom.php
@@ -147,46 +147,11 @@
             }
         }
     }
-// Load default settings for recpriority, autoexpire etc
+// Set some defaults
     else {
     // Make sure we have a default rectype
         if (!$schedule->type)
             $schedule->type = rectype_always;
-    // auto-metadata-lookup
-        if (!isset($schedule->autometadata))
-            $schedule->autometadata = setting('AutoMetadataLookup');
-    // auto-commercial-flag
-        if (!isset($schedule->autocommflag))
-            $schedule->autocommflag = setting('AutoCommercialFlag');
-    // auto-user-jobs
-        if (!isset($schedule->autouserjob1))
-            $schedule->autouserjob1 = setting('AutoRunUserJob1');
-        if (!isset($schedule->autouserjob2))
-            $schedule->autouserjob2 = setting('AutoRunUserJob2');
-        if (!isset($schedule->autouserjob3))
-            $schedule->autouserjob3 = setting('AutoRunUserJob3');
-        if (!isset($schedule->autouserjob4))
-            $schedule->autouserjob4 = setting('AutoRunUserJob4');
-    // auto-transcode
-        if (!isset($schedule->autotranscode))
-            $schedule->autotranscode = setting('AutoTranscode');
-    // transcoder
-        if (!isset($schedule->transcoder))
-            $schedule->transcoder = setting('DefaultTranscoder');
-    // recpriority
-        if (!isset($schedule->recpriority)) {
-            $result = mysql_query('SELECT recpriority from channel where chanid='.escape($program->chanid));
-            list($schedule->recpriority) = mysql_fetch_row($result);
-            mysql_free_result($result);
-        }
-    // autoexpire
-        if (!isset($schedule->autoexpire))
-            $schedule->autoexpire = setting('AutoExpireDefault');
-    // start early / end late
-        if (!isset($schedule->startoffset))
-            $schedule->startoffset = setting('DefaultStartOffset');
-        if (!isset($schedule->endoffset))
-            $schedule->endoffset = setting('DefaultEndOffset');
     // Get the searchtype string
         switch ($schedule->search) {
             case searchtype_power:   $schedule->search_type = t('Power');   break;
@@ -195,6 +160,8 @@
             case searchtype_title:
             default:                 $schedule->search_type = t('Title');   break;
         }
+    // Load default values from Default recording rule template
+        $schedule->merge(Schedule::recording_template('Default'));
     }
 
 // Create an edit-friendly title
diff --git a/modules/tv/schedules_manual.php b/modules/tv/schedules_manual.php
index 626ec39..6a2937a 100644
--- a/modules/tv/schedules_manual.php
+++ b/modules/tv/schedules_manual.php
@@ -120,39 +120,8 @@
     // Date/time/etc
         if (!$schedule->starttime)
             $schedule->starttime = time();
-    // auto-metadata-lookup
-        if (!isset($schedule->autometadata))
-            $schedule->autometadata = setting('AutoMetadataLookup');
-    // auto-commercial-flag
-        if (!isset($schedule->autocommflag))
-            $schedule->autocommflag = setting('AutoCommercialFlag');
-    // auto-user-jobs
-        if (!isset($schedule->autouserjob1))
-            $schedule->autouserjob1 = setting('AutoRunUserJob1');
-        if (!isset($schedule->autouserjob2))
-            $schedule->autouserjob2 = setting('AutoRunUserJob2');
-        if (!isset($schedule->autouserjob3))
-            $schedule->autouserjob3 = setting('AutoRunUserJob3');
-        if (!isset($schedule->autouserjob4))
-            $schedule->autouserjob4 = setting('AutoRunUserJob4');
-    // auto-transcode
-        if (!isset($schedule->autotranscode))
-            $schedule->autotranscode = setting('AutoTranscode');
-    // transcoder
-        if (!isset($schedule->transcoder))
-            $schedule->transcoder = setting('DefaultTranscoder');
-    // recpriority
-        if (!isset($schedule->recpriority)) {
-            $result = mysql_query('SELECT recpriority from channel where chanid='.escape($program->chanid));
-            list($schedule->recpriority) = mysql_fetch_row($result);
-            mysql_free_result($result);
-        }
-    // autoexpire
-        if (!isset($schedule->autoexpire)) {
-            $result = mysql_query("SELECT data from settings where value='AutoExpireDefault'");
-            list($schedule->autoexpire) = mysql_fetch_row($result);
-            mysql_free_result($result);
-        }
+    // Load default values from Default recording rule template
+        $schedule->merge(Schedule::recording_template('Default'));
     }
 
 // Calculate the length
diff --git a/modules/tv/tmpl/default/detail.php b/modules/tv/tmpl/default/detail.php
index cdd8093..8e9bfc5 100644
--- a/modules/tv/tmpl/default/detail.php
+++ b/modules/tv/tmpl/default/detail.php
@@ -488,7 +488,7 @@
             <th><?php echo t('More') ?>:</th>
             <td>
 <?php           if ($schedule->title) { ?>
-                <a href="http://www.themoviedb.org/search?search=<?php echo urlencode($schedule->title) ?>"><?php echo t('Search $1', 'themoviedb') ?></a>
+                <a href="http://www.themoviedb.org/search?query=<?php echo urlencode($schedule->title) ?>"><?php echo t('Search $1', 'themoviedb') ?></a>
                 <a href="http://www.imdb.com/search/title?title=<?php echo urlencode($schedule->title) ?>"><?php echo t('Search $1', 'IMDB') ?></a>
                 <a href="http://www.thetvdb.com/?string=<?php echo urlencode($schedule->title) ?>&searchseriesid=&tab=listseries&function=Search"><?php echo t('Search $1', 'TheTVDB') ?></a>
                 <a href="http://www.tv.com/search.php?type=11&stype=all&qs=<?php echo urlencode($schedule->title) ?>"><?php echo t('Search $1', 'TV.com') ?></a>
diff --git a/modules/tv/tmpl/default/recorded.php b/modules/tv/tmpl/default/recorded.php
index 203d4da..d1febd9 100644
--- a/modules/tv/tmpl/default/recorded.php
+++ b/modules/tv/tmpl/default/recorded.php
@@ -297,7 +297,7 @@ EOM;
 ?>
     file = new Object();
     file.title      = '<?php echo addslashes($show->title)                  ?>';
-    file.subtitle   = '<?php echo addslashes($show->subtitle)               ?>';
+    file.subtitle   = '<?php echo str_replace("\n", '', nl2br(addslashes($show->subtitle)))               ?>';
     file.chanid     = '<?php echo addslashes($show->chanid)                 ?>';
     file.starttime  = '<?php echo addslashes($show->recstartts)             ?>';
     file.recgroup   = '<?php echo addslashes(str_replace('%2F', '/', rawurlencode($show->recgroup)))    ?>';
diff --git a/modules/tv/tmpl/lite/detail.php b/modules/tv/tmpl/lite/detail.php
index dc124e4..2eba29d 100644
--- a/modules/tv/tmpl/lite/detail.php
+++ b/modules/tv/tmpl/lite/detail.php
@@ -65,7 +65,7 @@
                 </div>
                 <div id="external_searches">
                     (<?php echo t('Search') ?>: &nbsp;
-                    <a href="http://www.themoviedb.org/search?search=<?php echo urlencode($schedule->title) ?>"><?php echo t('themoviedb') ?></a>
+                    <a href="http://www.themoviedb.org/search?query=<?php echo urlencode($schedule->title) ?>"><?php echo t('themoviedb') ?></a>
                     &nbsp;-&nbsp;
                     <a href="http://www.imdb.com/search/title?title=<?php echo urlencode($schedule->title) ?>"><?php echo t('IMDB') ?></a>
                     &nbsp;-&nbsp;
diff --git a/modules/video/handler.php b/modules/video/handler.php
index fd769ce..721f186 100644
--- a/modules/video/handler.php
+++ b/modules/video/handler.php
@@ -15,8 +15,10 @@
  * @global  string   $GLOBALS['mythvideo_dir']
  * @name    $mythvideo_dir
 /**/
-    global $mythvideo_dir;
-    $mythvideo_dir = setting('VideoStartupDir', hostname);
+
+//// dont need this...
+//    global $mythvideo_dir;
+//    $mythvideo_dir = setting('VideoStartupDir', hostname);
 
 // Load the video storage directories
     $video_dirs = $db->query_list('
@@ -37,6 +39,7 @@
         }
     }
 
+/** nor any of this...
 // Make sure the video directory exists
     if (file_exists('data/video')) {
     // File is not a directory or a symlink
@@ -93,7 +96,7 @@
                         .' reload this page.');
         }
     // Create a symlink to the first artwork directory that we find.
-    /** @todo we should really support multiple directories, but it's too much effort to hack in at the moment. */
+    // @todo we should really support multiple directories, but it's too much effort to hack in at the moment.
         else {
             foreach ($artwork_dirs as $dir) {
                 if (is_dir($dir) || is_link($dir)) {
@@ -116,6 +119,7 @@
             }
         }
     }
+*/
 
     define('video_img_height',  _or(setting('web_video_thumbnail_height', hostname), 140));
     define('video_img_width',   _or(setting('web_video_thumbnail_width', hostname),   94));
@@ -125,11 +129,17 @@
         case 'edit':
             require_once 'modules/video/edit.php';
             exit;
-        case 'imdb':
-            require_once 'modules/video/imdb.php';
-            exit;
-        case 'scan':
-            require_once 'modules/video/scan.php';
+//// this is probably doing bad things
+//        case 'imdb':
+//            require_once 'modules/video/imdb.php';
+//            exit;
+//// this is broken, so disable it
+//        case 'scan':
+//            require_once 'modules/video/scan.php';
+//            exit;
+//// new stuff
+        case 'stream':
+            require_once 'modules/video/stream.php';
             exit;
     }
 
diff --git a/modules/video/stream.php b/modules/video/stream.php
new file mode 100644
index 0000000..49a7298
--- /dev/null
+++ b/modules/video/stream.php
@@ -0,0 +1,69 @@
+<?php
+/**
+ * Stream a music file
+ *
+ * @license     GPL
+ *
+ * @package     MythWeb
+ * @subpackage  Music
+/**/
+
+// Yes, a db connection
+    global $db;
+
+// Pull video ID
+    $vid_id = $_GET['Id'];
+
+// Get filename
+    list($fname) = $db->query_row('SELECT filename
+                                     FROM videometadata
+                                    WHERE intid = ?', $vid_id);
+
+// Mime type
+    switch (substr($fname, strrpos($fname, '.'))) {
+        case 'mpg':
+        case 'mpeg':
+            $mime = 'video/mpeg';
+            break;
+        case 'mp4':
+            $mime = 'video/mp4';
+            break;
+        case 'ogg':
+        case 'ogm':
+        case 'ogv':
+            $mime = 'video/ogg';
+            break;
+        case 'qt':
+            $mime = 'video/quicktime';
+            break;
+        case 'webm':
+            $mime = 'video/webm';
+            break;
+        case 'mkv':
+            $mime = 'video/x-matroska';
+            break;
+        case 'wmv':
+            $mime = 'video/x-ms-wmv';
+            break;
+        case 'flv':
+            $mime = 'video/x-flv';
+            break;
+        default:
+            $mime = 'applicatoin/octet-stream';
+    }
+    header('Content-Type: '.$mime);
+
+// Send the filename
+    header('Content-Disposition: filename="'.$fname.'"');
+
+// Send data via the backend
+    $Master_Host = setting('MasterServerIP');
+    $port = _or(get_backend_setting('BackendStatusPort', $Master_Host),
+                get_backend_setting('BackendStatusPort'));
+    if (stripos($Master_Host,':') !== false) {
+        $Master_Host = '['.$Master_Host.']';
+    }
+    readfile("http://$Master_Host:$port/Content/GetVideo?Id=".$vid_id);
+
+// Nothing else to do
+    exit;
diff --git a/modules/video/tmpl/default/video.php b/modules/video/tmpl/default/video.php
index e80176e..ad7e9a9 100644
--- a/modules/video/tmpl/default/video.php
+++ b/modules/video/tmpl/default/video.php
@@ -252,7 +252,7 @@
 <table width="100%" border="0" cellpadding="4" cellspacing="2" class="list small">
 <tr class="menu">
 <td>
- <span style="float: right"><input type="button" value="<?php echo t('Scan Collection'); ?>" class="submit" onclick="scan()"></span>
+<!-- Bad! Don't do this! <span style="float: right"><input type="button" value="<?php echo t('Scan Collection'); ?>" class="submit" onclick="scan()"></span> -->
  <form action="<?php echo root_url; ?>video" method="GET">
   <?php echo t('Display'); ?>:
   <select name="category" id="category" onchange="filter();">
diff --git a/mythweb.php b/mythweb.php
index bba2aa8..79ff196 100644
--- a/mythweb.php
+++ b/mythweb.php
@@ -30,7 +30,7 @@
     if (Modules::getModule($Path[0])) {
     // Add the current module directory to our search path, so modules can
     // define includes, etc.
-        ini_set('include_path', ini_get('include_path').':'.modules_path.'/'.$Path[0]);
+        ini_set('include_path', ini_get('include_path').PATH_SEPARATOR.modules_path.'/'.$Path[0]);
     // Load the module handler
         require_once 'handler.php';
     }
